\chapter{p-p Interactions and their Simulation}
\label{chap:event:MC}
\glsunset{atlas}

\Gls{pp} interactions at the \gls{lhc} are complex processes that span very different energy scales. 
In order to interpret the experimental data it is essential to develop a good understanding of the physics involved in the \gls{pp} collisions, and the ability to simulate the various processes is also crucial to be able to compare the observed data with the patterns predicted by the theory, first of all the \gls{sm}.
Section \ref{sec:ppint} focuses on the description of our understanding of a \gls{pp} collision, while Section \ref{sec:eventsimul} 
discusses the event-simulation process and the main \gls{mc} generators used in the \gls{atlas} Collaboration. 



\section{p-p Interactions}
\label{sec:ppint}

In hard-scattering processes, where the momentum transfer is much higher than the proton mass \cite{Butterworth:2012fj}, 
a \gls{pp} collision is easier to understand in terms of interactions between the constituents of the protons, quarks and gluons, 
collectively referred to as partons. A schematic view of \gls{pp} event is shown in Fig. \ref{fig:sim:pp2}. In this case, the interaction of a quark and a gluon leads to a final state with a Z boson and jets. 

\begin{figure}[h]
\begin{center}
%  \subfigure[]{
%    \label{fig:Comb_syst:pt}
    \includegraphics[width=0.58\textwidth]{figures/simul/ppcoll2}
%  }
\end{center}
 \caption{Schematic representation of a \gls{pp}, involving a quark-gluon scattering that leads to a final state consisting of a Z boson and a hard jet. Figure from Ref. \cite{Butterworth:2012fj}.}
  \label{fig:sim:pp2}
\end{figure}

As in can be understood from the figure, the hard process, which can be computed in perturbation theory, takes place between two of the proton partons; the probability that a gluon or a specific quark type takes part to the hard scattering is described the \glspl{partdf}, discussed in Section \ref{sec:ppint:hardscatter}. If the products of the hard scattering are quarks or gluons, after loosing energy by radiating other gluons (which in turn can generate quarks through gluon splitting) in the process of parton shower, they evolve into stable hadrons in the lower-energy hadronization process, which we can describe only through phenomenological models.
This picture is further complicated by the fact that also initial-state quarks and gluons can radiate. Also, the other partons not contributing to the hard scattering can interact, originating what is referred to as underlying event. 

\subsection{Factorization Theorem}
\label{sec:ppint:hardscatter}

The hard scattering between the partons inside the proton is in a kinematic regime where the \gls{qcd} coupling constant, $\alpha_s$, 
is small and therefore the partonic cross sections can be computed in perturbation theory. 
Thanks to the factorization theorem \cite{doi:10.1146}, the generic production cross section for a final state $X$ can be expressed in terms of the partonic cross section $\hat\sigma$ as:

\begin{equation}
  \sigma(pp\rightarrow X) = \sum_{i,j} \int dx_1 dx_2\, 
     f_{i}(x_1,\mu_F^2)\, f_{j}(x_2,\mu_F^2)\, 
     \hat\sigma_{ij\rightarrow X}(x_1 x_2 s, \mu_R^2, \mu_F^2) \; .
  \label{eq:general-cross-section}
\end{equation}
The $i$ and $j$ indexes run on all the possible partons, and $f_{i}(x_1,\mu_F^2)$ is the \gls{partdf} for the $i$-th parton, representing 
the distribution of probability for that parton to carry a fraction $x_1$ of the proton momentum when the proton is probed at a scale $\mu_F$
(factorization scale). $\hat\sigma_{ij\rightarrow X}$ is the partonic cross section, computer at the partonic center of mass energy \cmpart;   
it has to be noted that \cmpart is lower than the total center of mass energy, as its square is the product of square of the center of mass energy times
the fraction of the proton momentum that is carried by each of the two partons, $x_1$ and $x_2$. 
While, when considered at all orders in perturbative \gls{qcd}, the partonic cross section does not depend on $\mu_F$,
this dependence appears at any fixed order. $\hat\sigma$ depends also on the renormalization scale, $\mu_R$, which is the scale used for the evaluation of $\alpha_s$.



% factorization theorem 


%\begin{figure}[h]
%\begin{center}
%  \subfigure[]{
%    \label{fig:Comb_syst:pt}
%    \includegraphics[width=0.48\textwidth]{figures/simul/ppcoll2}
%  }
%    \subfigure[]{
%    \label{fig:Comb_syst:pt}
%    \includegraphics[width=0.48\textwidth]{figures/simul/ppcoll}
%  }
%\end{center}
% \caption{Diagrammatic structure of a generic hard-scattering process. Figure from Ref. \cite{Campbell:2006wx}.}
%  \label{fig:sim:pp}
%\end{figure}

\subsection{Parton Density Functions}
\label{sec:protpdf}

The partons inside the proton can not be observed as free particles, and therefore their \glspl{partdf} can not be computed with
perturbative \gls{qcd}. In particular, for a given scale, it is not possible to predict theoretically the probability distribution 
of the momentum fraction. Instead, once the \glspl{partdf} are known for a certain scale, their energy evolution is 
determined by the equations derived independently by Dokshitzer \cite{Dokshitzer:1977sg} , Gribov and Lipatov \cite{Gribov:1972ri}, and Altarelli and Parisi \cite{ALTARELLI1977298} (DGLAP equations):

\begin{equation}
\begin{aligned}
\frac{\partial q(x,Q^2)}{\partial {\rm log}Q^2}~&=~\frac{\alpha_s}{2\pi}~\left( P_{qq} \otimes q~+~P_{qg} \otimes g \right) \, \\
\frac{\partial g(x,Q^2)}{\partial {\rm log}Q^2}~&=~\frac{\alpha_s}{2\pi}~\left( \sum_i P_{gq} \otimes (q_i+\bar{q}_i)~+~P_{gg} \otimes g \right) \; .
\label{eq:glap1}
\end{aligned}
\end{equation}

\noindent In the expressions above, $q(x,Q^2)$ and $g(x,Q^2)$ are the quark and gluon \gls{partdf} respectively, 
$P_{ij}$ describes the $i \to j$ parton splitting function
and $\otimes$ is a symbol for the convolution integral:
\begin{equation}
P \otimes f \equiv \int^1_x\frac{dy}{y}f_q(y)~P\left(\frac{x}{y}\right).
\end{equation}

As mentioned above, the $x$ dependence has to be extracted experimentally. This is done by several collaborations through fits (with typically 10 to 30 parameters) to data of \gls{dis}. As an example, Figure \ref{fig:sim:pp} shows the \gls{nlo} \glspl{partdf} obtained by the MSTW Collaboration for two different scales, Q$^2$ = 10 GeV$^2$ and Q$^2$ = 10$^4$ GeV$^2$. It is possible to notice how, with the increase of Q$^2$, the shape of the \glspl{partdf} changes to favor lower $x$ values. At low $x$ values the gluon \gls{pdf} is dominating (and this effect increases with Q$^2$), while for high $x$ values the \glspl{partdf} of the valence quarks are more relevant.

\begin{figure}[h]
\begin{center}
    \includegraphics[width=0.8\textwidth]{figures/simul/pdf}
\end{center}
\caption{MSTW 2008 \gls{nlo} \glspl{partdf} at Q$^2$ = 10 GeV$^2$ and Q$^2$ = 10$^4$ GeV$^2$. Figure from Ref. \cite{Martin:2009iq}.}
 \label{fig:sim:pp}
\end{figure}


\section{Event Simulation}
\label{sec:eventsimul}

The main steps in the simulation of \gls{pp} collision events consists of:
\begin{itemize}
\item Computation of the matrix element for the hard process.
\item \gls{psh} and matching between \gls{psh} and matrix element.
\item Hadronization and decay of unstable particles.
\item Simulation of the underlying event.
\end{itemize}
In the next sections, each step is summarized in its main features.

\subsection{Matrix Element}

As discussed e.g. in Ref \cite{Skands:2011pf}, the partonic cross section for the production of the final state $X$ starting from the partons $i$ and $j$, necessary to compute
Equation \ref{eq:general-cross-section}, can be expressed at all orders as:
\begin{equation}
\hat\sigma_{ij\rightarrow X} = \sum_{k=0}^\infty \int d\Phi_{X+k} |\sum_{l=0}^\infty \mathcal{M}_{X+k}^{(l)}|^2 \; .
\label{eq:xsec_matrix}
\end{equation}
\noindent In this expression, the $k$ represents the number of final state quarks and gluons produced in addition to $X$ and $\mathcal{M}_{X+k}^{(l)}$
the amplitude to produce the final state $X+k$ computed with $l$ virtual loops. To compute a cross section is not possible to extend these sums to infinity, and the number of extra partons and the number of loops identify the 
perturbative order of the cross section. In particular:
\begin{itemize}
\item The lowest possible order for the production of $X$ is the \gls{lo}, where $k=l=0$.
\item $l=0$, $k=n$ represents the \gls{lo} computation for the production of $X$ + $n$ jets.
\item $k+l \leq n$ corresponds to a N$^n$LO prediction for the production of $X$, while N$^{n-k}$LO for the production of $X$ in association with $k$ jets.
\end{itemize}

At each order, the computation of the matrix element implies a choice of the factorization and renormalization scales.
$\mu_F$ and $\mu_R$ are not predetermined, and are typically set to values related to the scale of the considered physical process. 
The impact of this subjective choice is taken into account by evaluating each production cross section at different scales (typically a variation of a factor two up and down), and assigning the difference as a systematic uncertainty on the cross section estimate.


\subsection{Parton Shower}

The theorem from Kinoshita, Lee and Nauenberg (KLN theorem) \cite{Kinoshita:1962ur,Lee:1964is} guarantees that, 
when computing inclusive cross sections, the logarithmic divergences arising from collinear splitting cancel against the virtual corrections order by order in perturbation theory. 
This does not hold anymore when we are interested in the computation of a differential cross section, for example with a specific number of accompanying final-state extra partons, 
as it could be the case $l=0, k=1$ in Equation \ref{eq:xsec_matrix}. 
In this case, the kinematic of the basic inclusive event is simulated at fixed order, and the \gls{qcd} emission process (splitting) is carried out by the \gls{psh} algorithms \cite{Fox:1979ag}, that generate an ordered sequence of emissions with decreasing angle and energy; the \gls{psh} approximation consists in retaining only the largest matrix elements, namely the ones corresponding to low angles and energies, obtaining a \gls{ll} accuracy.
There are three types of processes that need to be taken care of by the \gls{psh}: $g \rightarrow q\bar{q}$, $g \rightarrow gg$ and $q \rightarrow q g$.
The probability for a parton to evolve from an energy $t$ to a lower energy $t'$ without splitting is encoded in the Sudakov form factor:
\begin{equation}
  \Delta_i(t,t')=\exp\left(-\sum_{j\in\{q,g\}}\,
  \int_t^{t'}\frac{\rm{d}\bar{t}}{\bar{t}}\int_{z_{\rm min}}^{z_{\rm max}}\rm{d} z\,
  \frac{ \alpha_s }{2 \pi } \, \frac{1}{2} \, P_{ij}(z) \right) \;,
  \label{eq:sudakov_intro}
\end{equation}

\noindent where $P_{ij}$ is the parton splitting function (described in Section \ref{sec:protpdf}).
Equation \ref{eq:sudakov_intro} is sampled with \gls{mc} techniques to produce the sequence of splittings, until the hadronization scale is reached. 

Also incoming particles can emit extra partons, giving rise to \gls{isr}. While in the case of \gls{fsr} the first emissions are harder than the following ones, for \gls{isr} the ordering is inverted, and the showering is performed with a backwards-evolution algorithm \cite{Sjostrand:1985xi}.

\subsection{Matching}

When a process F is simulated with \gls{lo} matrix element plus \gls{psh}, as illustrated in the left diagram in Figure \ref{fig:sim:matching} (following the discussion in Ref. \cite{Skands:2011pf}), the hardest extra jet is at \gls{ll} accuracy. 
One might wish to improve the accuracy of the description of the event by adding the \gls{lo} matrix element for the process F with the addition of one extra parton (F+1), as in the second diagram in Figure \ref{fig:sim:matching}. In this figure, the boxes are only partially filled to indicate the phase-space restriction necessary to deal with the divergence of the F+1 matrix element. Adding naively these two pieces leads to double counting, as illustrated in the third diagram of Figure \ref{fig:sim:matching}. 
This double-counting problem worsens with the increase of the number of extra legs that we want to add at matrix element.

\begin{figure}[h]
\begin{center}
    \includegraphics[width=\textwidth]{figures/simul/matching}
\end{center}
\caption{Illustration of the source of possible double-counting originating from adding matrix elements with different number of legs. Figure from Ref. \cite{Skands:2011pf}.}
 \label{fig:sim:matching}
\end{figure}

Different methods have been designed to match matrix elements to showers such that, for each order in perturbation theory, double-counting is avoided. The three main strategies are \cite{Giele:2011cb}:
\begin{description}
\item[Unitarity] This approach consists in correcting the shower splitting functions by multiplicative factors obtained as the ration of matrix elements to shower approximation:
\begin{equation}
\rm{Matched} = \rm{Approximate}\frac{\rm{Exact}}{Approximate} \; .
\end{equation}
\noindent When these correction factors are inserted in the shower evolution, they guarantee that the shower evolution of the process F describes correctly also the F+1 matrix element, without actually adding the F+1 sample. This strategy, adopted by Powheg and Pythia, had traditionally been worked out only for one extra parton emission. 

\item[Subtraction]

\begin{equation}
\rm{Matched} = \rm{Approximate} + (\rm{Exact}- \rm{Approximate}) \; .
\end{equation}

\item[Slicing]
\end{description}


\subsection{Hadronization and Hadron Decays}

At the end of the shower we have emissions at very low energy and angles, which correspond to high values of the \gls{qcd} coupling constant. 
When the strong coupling becomes of order unit, the interaction is very strong and this is presumably what gives rise to hadronization, the process where colored partons, after parton shower, become a set of colorless hadrons (primary hadrons), 
that can in turn decay into secondary hadrons. This transition is described through phenomenological models since the hadrinization scale, that corresponds also to the \gls{ir} cutoff of the parton shower, is outside the perturbative regime of \gls{qcd}. At the end of the shower, the color, flavour and momentum distribution is already organized, and the hadronization process can only do a local redistribution.
Two main hadronization models are used in \gls{mc} generators:

\begin{description}
\item[String Model] The string model \cite{Artru:1974hr} is based on linear confinement: the potential energy between two colored particles increases linearly with their distance, when the distance is greater than about 1 fm (while at shorter distances also a Coulomb term is present). This terms comprises several different models, among which the most used nowadays is the Lund model \cite{Andersson:1983ia,Andersson:1998tv}. 
A color string forms that joins the the final state in a string configuration of field energies, and hadrons originate from the breakups of the string. The proportionality constant of the linear inter-quark potential can be measured from quarkonia spectra or from lattice \gls{qcd}, and results to be $\approx$ 1 GeV/fm.

The main difference between quarks and gluons resides in the fact that, while quarks are connected to one single string, gluons are connected to two and have therefore a rate for hadron production double than that of quarks. 

% chiara: describe the main steps of the string model hadronization

The fragmentation function determines the probability of a given hadron to carry a certain fraction of the available momentum. In the Lund model the form of the fragmentation function is constrained by the left-right symmetry necessary to make the model independent on the sequence of string breakups. The resulting function depends on the mass and \pt of the hadron, leading to heavier hadrons carrying on average an higher fraction of the momentum.

\item[Cluster Model] The cluster model is based on preconfinement. The clusters of color and anti-color, instead of forming a string, at a sufficient low scale can decay directly into (possibly unstable) hadrons. The mass distribution of the preconfined clusters results to be independent on the scale and nature of the original hard process. This universal distribution of the cluster mass peaks below 1 GeV, with a tail that extends to above 10 GeV; these cluster with very high mass are decayed as a string.  

\end{description}

These two hadronization models have been developed in the 1980's, and since then there has been no fundamental progress in the theoretical understanding of hadronization. 
When the simulation of the events stops before hadronization, it is referred to as "parton-level".

\subsection{Underlying Event}

Protons contain more than one quark, and they can undergo interactions as well, giving origin to multiple parton interactions in the same collision.
These secondary interactions are in general of lower momentum, since the matrix element is larger for low momentum transfer, and will contribute to the activity along the beam direction, less in the transverse plane. 
When the two protons pass through each other the likelihood of having multiple interactions depends on the overlap between the two protons. 
To model the underlying event, the assumption is made that these processes are $2\rightarrow2$ scattering; the matrix element for these diverges at small angle, so the modelling is dependent on the chosen \pt cutoff. 
To model the data, color reconnection between the primary interaction and the underlying event is needed. 

\subsection{Pileup}

\section{MC Generators}

\subsection{General Purpose Generators}

Several independent codes allow to study the effects of different modelling of the hadronization and different choices for the parton shower. The three main general-purpose event generators are:

\begin{description}
\item[Pythia] \cite{Sjostrand:2006za,Sjostrand:2014zea} Uses \pt-ordered parton shower and string hadronization.
\item[Herwig] \cite{Corcella:2000bw,Bahr:2008pv,Bellm:2015jjp} Uses angular-ordered parton shower and cluster hadronization. Gluon splitting processes ($g \rightarrow q\bar{q}$ and $g \rightarrow gg$) in the collinear approximation are not symmetric in the azimuthal direction due to interference of positive and negative helicity states in the original gluon. While Pythia uses a method that takes these affects into account only partially \cite{Webber:1987uy}, Herwig uses one that fully includes spin correlations \cite{Collins:1987cp}. 
\item[Sherpa] \cite{Gleisberg:2008ta} Uses dipole-type parton shower and cluster hadronization. 
\end{description}

The recent versions of all three generators are coded in c++, but Herwig and Pythia were originally developed in Fortran.  

\subsection{Matrix Elements Generators}
\begin{description}
\item[Powheg] 
\end{description}

\subsection{Specialized Generators}


\section{Detector Simulation}

After the detector simulation, the \gls{mc} simulated events are treated in the same manner as data, going through the object reconstruction procedures
describes in Chapter \ref{sec:event:reco}.

\section{Data-driven Corrections}
